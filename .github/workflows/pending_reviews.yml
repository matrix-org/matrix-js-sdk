name: Pending Reviews
on:
    pull_request:
        types: [opened, synchronize, review_requested, review_request_removed, ready_for_review]
    pull_request_review:
        types: [submitted, dismissed]
    workflow_call: {}
concurrency: ${{ github.workflow }}-${{ github.event.workflow_run.head_branch }}
jobs:
    reviews:
        name: Assert no outstanding reviews
        runs-on: ubuntu-latest
        permissions:
            pull-requests: read
            checks: write
        steps:
            - id: prdetails
              uses: matrix-org/pr-details-action@v1.2
              with:
                  owner: ${{ github.event.workflow_run.head_repository.owner.login }}
                  branch: ${{ github.event.workflow_run.head_branch }}

            - name: 🔍 Check reviewers
              uses: actions/github-script@v5
              env:
                  PR_ID: ${{ steps.prdetails.outputs.pr_id }}
                  HEAD_SHA: ${{ fromJSON(steps.prdetails.outputs.data).head.sha }}
                  REQUESTED_REVIEWERS: ${{ toJSON(fromJSON(steps.prdetails.outputs.data).requested_reviewers) }}
                  REQUESTED_TEAMS: ${{ toJSON(fromJSON(steps.prdetails.outputs.data).requested_teams) }}
              with:
                  script: |
                      const { PR_ID: pull_number, HEAD_SHA: sha, REQUESTED_REVIEWERS, REQUESTED_TEAMS } = process.env;
                      const requested_reviewers = JSON.parse(REQUESTED_REVIEWERS);
                      const requested_teams = JSON.parse(REQUESTED_TEAMS);

                      const reviews = await github.rest.pulls.listReviews({
                          pull_number,
                          owner,
                          repo,
                      });

                      const pending = requested_reviewers.length
                          || requested_teams.length
                          || reviews.some(r => r.state !== "APPROVED");

                      await octokit.rest.repos.createCommitStatus({
                          context: "Pending reviews",
                          sha,
                          state: pending ? "failure" : "success",
                          description: pending ? "Outstanding pending reviews" : undefined,
                          owner,
                          repo,
                      });
