name: Pending Reviews
on:
    pull_request:
        types: [opened, synchronize, review_requested, review_request_removed, ready_for_review]
    pull_request_review:
        types: [submitted, dismissed]
    workflow_call: {}
concurrency: ${{ github.workflow }}-${{ github.event.workflow_run.head_branch }}
jobs:
    reviews:
        name: Assert no outstanding reviews
        runs-on: ubuntu-latest
        permissions:
            pull-requests: read
            checks: write
        steps:
            - name: 🔍 Check reviewers
              uses: actions/github-script@v5
              env:
                  head: ${{ github.event.workflow_run.head_repository.owner.login }}:${{ github.event.workflow_run.head_branch }}
                  repo: ${{ github.repository }}
              with:
                  # We need to find the PR number that corresponds to the branch, which we do by searching the GH API
                  # The workflow_run event includes a list of pull requests, but it doesn't get populated for
                  # forked PRs: https://docs.github.com/en/rest/reference/checks#create-a-check-run
                  script: |
                      const { repo: ownerRepo, head } = process.env;
                      const [owner, repo] = ownerRepo.split("/");
                      const pulls = await github.rest.pulls.list({
                          head,
                          owner,
                          repo,
                      });
                      const pull = pulls[0];
                      const pull_number = pull.number;
                      const reviews = await github.rest.pulls.listReviews({
                          pull_number,
                          owner,
                          repo,
                      });

                      const pending = pull.requested_reviewers.length
                          || pull.requested_teams.length
                          || reviews.some(r => r.state !== "APPROVED");

                      await octokit.rest.repos.createCommitStatus({
                          context: "Pending reviews",
                          sha: pull.head.sha,
                          state: pending ? "failure" : "success",
                          description: pending ? "Outstanding pending reviews" : undefined,
                          owner,
                          repo,
                      });
