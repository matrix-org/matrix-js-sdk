name: Publish to npm
on:
    workflow_call:
        outputs:
            id:
                description: "The npm package@version string we published"
                value: ${{ jobs.npm.outputs.id }}
permissions: {}
jobs:
    npm:
        name: Publish to npm
        runs-on: ubuntu-24.04
        permissions:
            contents: read
            id-token: write
        outputs:
            id: ${{ steps.npm-publish.outputs.id }}
        steps:
            - name: ðŸ§® Checkout code
              uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5
              with:
                  ref: staging

            - name: ðŸ”§ Yarn cache
              uses: actions/setup-node@2028fbc5c25fe9cf00d9f06a71cc4710d4507903 # v6
              with:
                  cache: "yarn"
                  registry-url: "https://registry.npmjs.org"
                  node-version-file: package.json

            # Ensure npm 11.5.1 or later is installed
            - name: Update npm
              run: npm install -g npm@latest

            - name: ðŸ”¨ Install dependencies
              run: "yarn install --frozen-lockfile"

            - name: ðŸš€ Publish to npm
              run: npm publish --provenance --access public --tag "$TAG"
              env:
                  NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
                  TAG: ${{ contains(steps.npm-publish.outputs.id, '-rc.') && 'next' || 'latest' }}
