name: Tests
on:
    pull_request: {}
    merge_group:
        types: [checks_requested]
    push:
        branches: [develop, master]
concurrency:
    group: ${{ github.workflow }}-${{ github.ref }}
    cancel-in-progress: true
jobs:
    jest:
        name: "Jest [${{ matrix.specs }}] (Node ${{ matrix.node }})"
        runs-on: ubuntu-latest
        timeout-minutes: 10
        strategy:
            matrix:
                specs: [browserify, integ, unit]
                node: [16, 18, latest]
        steps:
            - name: Checkout code
              uses: actions/checkout@v3

            - name: Setup Node
              uses: actions/setup-node@v3
              with:
                  cache: "yarn"
                  node-version: ${{ matrix.node }}

            - name: Install dependencies
              run: "yarn install"

            - name: Build
              if: matrix.specs == 'browserify'
              run: "yarn build"

            - name: Get number of CPU cores
              id: cpu-cores
              uses: SimenB/github-actions-cpu-cores@410541432439795d30db6501fb1d8178eb41e502 # v1

            - name: Load metrics reporter
              id: metrics
              if: github.ref == 'refs/heads/develop'
              run: |
                  echo "extra-reporter='--reporters=<rootDir>/spec/slowReporter.js'" >> $GITHUB_OUTPUT

            - name: Run tests
              run: |
                  yarn ${{ github.event_name == 'merge_group' && 'test' || 'coverage' }} \
                      --ci \
                      --reporters github-actions ${{ steps.metrics.outputs.extra-reporter }} \
                      --max-workers ${{ steps.cpu-cores.outputs.count }} \
                      ./spec/${{ matrix.specs }}
              env:
                  JEST_SONAR_UNIQUE_OUTPUT_NAME: true

            - name: Move coverage files into place
              if: github.event_name != 'merge_group'
              run: mv coverage/lcov.info coverage/${{ matrix.node }}-${{ matrix.specs }}.lcov.info

            - name: Upload Artifact
              if: github.event_name != 'merge_group'
              uses: actions/upload-artifact@v3
              with:
                  name: coverage
                  path: |
                      coverage
                      !coverage/lcov-report

    skip_sonar:
        name: Skip SonarCloud on merge_queue
        if: github.event_name == 'merge_group'
        runs-on: ubuntu-latest
        needs: jest
        steps:
            - name: Skip SonarCloud
              uses: Sibz/github-status-action@faaa4d96fecf273bd762985e0e7f9f933c774918 # v1
              with:
                  authToken: ${{ secrets.GITHUB_TOKEN }}
                  state: success
                  description: SonarCloud skipped
                  context: SonarCloud Code Analysis
                  sha: ${{ github.sha }}
                  target_url: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}

    matrix-react-sdk:
        name: Downstream test matrix-react-sdk
        if: github.event_name == 'merge_group'
        uses: matrix-org/matrix-react-sdk/.github/workflows/tests.yml@develop
        with:
            disable_coverage: true
            matrix-js-sdk-sha: ${{ github.sha }}

    # Hook for branch protection to work outside merge queues
    downstream:
        name: Downstream tests
        runs-on: ubuntu-latest
        if: always()
        needs:
            - matrix-react-sdk
        steps:
            - if: needs.matrix-react-sdk.result != 'skipped' && needs.matrix-react-sdk.result != 'success'
              run: exit 1
